# Site review – missing pieces

## Preview/demo mode added for local QA
- เมื่อยังไม่ได้ตั้งค่า `.env.local` เว็บไซต์จะโหลดข้อมูลสินค้า โปรโมชัน และรีวิวตัวอย่างเพื่อให้ทีมสามารถพรีวิวหน้าเพจได้โดยไม่ต้องเชื่อมต่อฐานข้อมูลทันที พร้อมแสดงแบนเนอร์แจ้งว่าเป็นโหมดตัวอย่างและปิดการส่งรีวิวจริงไว้ก่อน.【F:app/(site)/page.js†L1-L120】【F:components/ReviewsShowcase.jsx†L14-L520】
- API ที่เกี่ยวข้องกับหน้า storefront (`/api/products`, `/api/products/[id]`, `/api/promotions/active`, `/api/reviews`) จะคืนข้อมูลจาก `lib/sampleData.js` พร้อมแนบ `x-demo-data: true` เมื่อฐานข้อมูลยังไม่พร้อม หรือเกิดข้อผิดพลาดในการเชื่อมต่อ เพื่อให้ UI ส่วนอื่นๆ เช่นตะกร้าและแถบโปรโมชันยังใช้งานได้.【F:lib/sampleData.js†L1-L149】【F:app/api/products/route.js†L1-L73】【F:app/api/products/[id]/route.js†L1-L82】【F:app/api/promotions/active/route.js†L1-L35】【F:app/api/reviews/route.js†L1-L88】
- เมื่อเตรียมค่า environment และ seed ข้อมูลจริงเรียบร้อยแล้ว ระบบจะดึงข้อมูลจาก MongoDB ตามปกติ (แถบแจ้งโหมดตัวอย่างจะหายไป) จึงยังจำเป็นต้องทำตามเช็กลิสต์ด้านล่างให้ครบก่อนเปิดขายจริง

## 1. Runtime configuration you must supply
- **MongoDB connection** – Every API handler calls `connectToDatabase`, which immediately throws when `MONGODB_URI` is missing. This blocks storefront data, checkout, pre-order capture, and every admin aggregation until the URI exists in `.env.local`.【F:lib/db.js†L1-L9】【F:app/api/promotions/active/route.js†L1-L18】【F:app/api/reviews/route.js†L1-L74】【F:app/api/products/route.js†L1-L40】【F:app/api/admin/stats/route.js†L1-L44】【F:app/api/preorders/route.js†L1-L60】【F:app/api/checkout/route.js†L1-L88】
- **NextAuth secrets & site URL** – Authentication relies on the credentials provider backed by MongoDB and the middleware only grants `/admin` or `/orders` access when a signed JWT exists. Provision `NEXTAUTH_SECRET` (or `AUTH_SECRET`) and `NEXTAUTH_URL`, otherwise login attempts—including the admin credentials—will fail or produce runtime warnings.【F:lib/auth.js†L1-L74】【F:middleware.js†L1-L26】
- **Cloudinary upload keys** – Product management posts images to `/api/upload`, which immediately configures the Cloudinary SDK with `CLOUDINARY_CLOUD_NAME`, `CLOUDINARY_API_KEY`, and `CLOUDINARY_API_SECRET`. Without them any upload attempt will return HTTP 500.【F:app/api/upload/route.js†L1-L26】
- **PromptPay / bank details** – Checkout and post-purchase flows read payment identifiers from `getPaymentConfig`. If you do not override the placeholder PromptPay ID and bank account via environment variables (`PROMPTPAY_ID`, `BANK_ACCOUNT_*`), customers will see fake data on the QR screen and in payment instructions.【F:lib/paymentConfig.js†L1-L18】【F:app/api/checkout/route.js†L89-L200】【F:app/api/orders/[id]/payment/route.js†L1-L79】

## 2. Accounts and seed data still required
- **Admin account** – The credentials provider fetches users from MongoDB and compares hashes. Seed at least one `User` document with `role: "admin"` and a bcrypt-hashed password that matches your chosen login before sharing admin credentials.【F:lib/auth.js†L11-L42】【F:models/User.js†L1-L17】
- **Product catalog & inventory** – The home page, checkout, and admin reporting all expect populated `Product` records with prices, stock, and image URLs; otherwise customers only see the “เมนูซาลาเปากำลังนึ่งอยู่” placeholder and inventory reservation cannot run.【F:app/(site)/page.js†L1-L120】【F:app/api/checkout/route.js†L17-L120】【F:models/Product.js†L1-L33】
- **Customer reviews** – Featured testimonials on the landing page and the `/api/reviews` endpoint both read from MongoDB. Seed `Review` documents so the carousel is populated and so early customers can see social proof.【F:app/(site)/page.js†L15-L45】【F:app/api/reviews/route.js†L1-L73】【F:models/Review.js†L1-L16】
- **Promotions & coupons** – Cart price calculations pull active promotions and coupons from the database. Populate `Promotion` and `Coupon` collections so the ticker, cart badge, and checkout discount logic can run end to end.【F:components/PromotionsTicker.jsx†L1-L64】【F:components/cart/CartProvider.jsx†L1-L88】【F:app/api/promotions/active/route.js†L1-L20】【F:app/api/checkout/route.js†L88-L200】【F:models/Promotion.js†L1-L17】【F:models/Coupon.js†L1-L16】
- **Orders with realistic data** – Admin dashboards aggregate revenue, profit, and low-stock alerts from existing `Order`, `Product`, and `PreOrder` documents. Seed representative orders (including `costPrice`) so KPIs, charts, and low-stock counts render properly.【F:app/api/admin/stats/route.js†L1-L64】【F:models/Order.js†L1-L88】【F:models/PreOrder.js†L1-L48】
- **Pre-order pipeline** – The public pre-order form saves requests through `/api/preorders`. Populate sample `PreOrder` entries or test submissions after MongoDB is configured so the admin view has data to triage.【F:app/(site)/preorder/page.jsx†L1-L96】【F:app/api/preorders/route.js†L1-L84】【F:models/PreOrder.js†L1-L48】

## 3. Customer journey gaps to validate after seeding
- **Authentication gate before purchasing** – The add-to-cart button forces unauthenticated visitors to log in. Confirm session handling and redirects work once NextAuth is configured so customers can build carts smoothly.【F:components/AddToCartButton.jsx†L1-L64】
- **Checkout creation & payment confirmation** – Placing an order calls `/api/checkout`, reserves stock, and generates PromptPay or bank instructions; confirming payment later posts base64 slips to `/api/orders/{id}/confirm`. Test both flows with seeded data and real environment variables to ensure orders reach the “verifying” state.【F:app/(site)/checkout/page.jsx†L1-L212】【F:app/api/checkout/route.js†L1-L200】【F:app/api/orders/[id]/confirm/route.js†L1-L104】
- **Order history for customers** – `/orders` depends on authenticated sessions and a working `/api/my/orders` endpoint. After seeding orders tied to a user, verify that histories render and empty/error states behave as expected.【F:app/(site)/orders/page.jsx†L1-L140】【F:app/api/my/orders/route.js†L1-L18】
- **Pre-order detail enrichment** – When a customer opens the pre-order form from a product, the page fetches `/api/products/{id}`. Ensure product IDs resolve and pricing/copy are accurate so staff know how to follow up.【F:app/(site)/preorder/page.jsx†L17-L80】【F:app/api/products/[id]/route.js†L1-L44】

## 4. Back-office readiness checkpoints
- **Admin-only API protection** – Admin routes lean on NextAuth session roles. After configuring secrets, confirm that non-admin accounts receive 403 responses from `/api/products`, `/api/coupons`, `/api/promotions`, and `/api/admin/stats` while admins can manage catalog data.【F:app/api/products/route.js†L8-L54】【F:app/api/coupons/route.js†L1-L33】【F:app/api/promotions/route.js†L1-L54】【F:app/api/admin/stats/route.js†L1-L44】【F:middleware.js†L9-L26】
- **Image management** – Catalog management expects Cloudinary uploads to succeed and returns a secure URL. Decide on folders, transformations, and retention before onboarding staff to the admin UI.【F:app/api/upload/route.js†L1-L26】
- **Inventory reconciliation** – Both checkout and manual admin order creation reserve and release stock using `reserveInventory`/`releaseInventory`. Review `stock` levels in each `Product` seed so reservations, low-stock warnings, and cancellation flows behave predictably.【F:app/api/checkout/route.js†L25-L120】【F:app/api/orders/route.js†L1-L90】【F:lib/inventory.js†L1-L96】

## 5. Suggested next steps
1. Populate `.env.local` with all required secrets (`MONGODB_URI`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, Cloudinary keys, PromptPay/Bank identifiers) and restart the app so every API route can connect to external services.【F:lib/db.js†L1-L9】【F:lib/auth.js†L1-L74】【F:app/api/upload/route.js†L1-L26】【F:lib/paymentConfig.js†L1-L18】
2. Seed MongoDB with baseline content: admin user, active products (with `price`, `stock`, `images`), promotions, coupons, published reviews, sample orders, and pre-orders so the storefront, cart math, and dashboards display meaningful data.【F:models/User.js†L1-L17】【F:models/Product.js†L1-L33】【F:models/Promotion.js†L1-L17】【F:models/Coupon.js†L1-L16】【F:models/Review.js†L1-L16】【F:models/Order.js†L1-L88】【F:models/PreOrder.js†L1-L48】
3. After configuration and seeding, walk through the major journeys (browse → cart → checkout → payment confirmation, customer order history, admin dashboards) to confirm there are no authorization, data integrity, or missing-content regressions.【F:components/AddToCartButton.jsx†L1-L64】【F:app/(site)/checkout/page.jsx†L1-L212】【F:app/api/orders/[id]/confirm/route.js†L1-L104】【F:app/api/admin/stats/route.js†L1-L64】
